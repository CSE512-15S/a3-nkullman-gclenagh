<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: auto;
  position: relative;
  width: 960px;
}

text {
  font: 10px sans-serif;
}

form {
  position: absolute;
  right: 10px;
  top: 10px;
}

svg {
  font: 10px sans-serif;
}
.area {
  fill: steelblue;
  clip-path: url(#clip);
}
.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
.brush .extent {
  stroke: steelblue;
  fill-opacity: .125;
  shape-rendering: crispEdges;
}

</style>
<form>
  <label><input type="radio" name="dataset" value="alldays" checked>All Days</label>
  <label><input type="radio" name="dataset" value="weekdays">Weekdays</label>
  <label><input type="radio" name="dataset" value="weekends">Weekends</label>
</form>
Max Temperature:
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

d3.csv("fremont.csv", function(csv) //load data
{
	var barwidth = 200,
		barheight = 20;

	var temp_selection = [30, 95];
	var precip_selection = [0, 2.49];
	
	var temp_scale = d3.scale.linear()
		.domain(temp_selection)
		.range([0,barwidth]);
	
	var precip_scale = d3.scale.linear()
		.domain(precip_selection)
		.range([0,barwidth]);

	var temp_brush = d3.svg.brush()
		.x(temp_scale)
		.on("brush", temp_brushed);
	var temp_axis = d3.svg.axis()
		.scale(temp_scale)
		.orient("bottom")
		.ticks(5);
	var tempbar = d3.select("body")
		.append("svg")
		.attr("width", barwidth)
		.attr("height", barheight);
	tempbar.append("g")
		.attr("class", "x axis")
		.call(temp_axis);
	tempbar.append("g")
		.attr("class", "brush")
		.call(temp_brush)
		.selectAll("rect")
		.attr("height", barheight);
	
	var precip_brush = d3.svg.brush()
		.x(precip_scale)
		.on("brush", precip_brushed);
	var precip_axis = d3.svg.axis()
		.scale(precip_scale)
		.orient("bottom")
		.ticks(5);
	var precipbar = d3.select("body")
		.append("svg")
		.attr("width", barwidth)
		.attr("height", barheight);
	precipbar.append("g")
		.attr("class", "x axis")
		.call(precip_axis);
	precipbar.append("g")
		.attr("class", "brush")
		.call(precip_brush)
		.selectAll("rect")
		.attr("height", barheight);

	var data = d3.nest() //initial aggregation
		.key(function(d) {return d.Direction;})
		.key(function(d) {return d.Time;})
		.sortKeys(d3.ascending)
		.rollup(function(d)
		{
			return d3.mean(d, function(g) {return +g.CyclistCount;});
		})
		.map(csv);
	var numdays = Math.ceil(csv.length/48);
	
	d3.selectAll("input")
		.on("change", change);
	
	function change()
	{
		//Reaggragate data with new filters
		var value = this.value;
		var csv_filtered;
		if (value == "weekdays")
		{
			csv_filtered = csv.filter(function(d) { return d.IsWeekday == "TRUE"; });
		} else if (value == "weekends")
		{
			csv_filtered = csv.filter(function(d) { return d.IsWeekday == "FALSE"; });
		} else 
		{
			csv_filtered = csv;
		}
		csv_filtered = csv_filtered.filter(function(d)
		{
			return temp_selection[0] <= d.Max_TemperatureF &&
				d.Max_TemperatureF <= temp_selection[1] &&
				precip_selection[0] <= d.PrecipitationIn &&
				d.PrecipitationIn <= precip_selection[1];
		});
		
		data = d3.nest()
		.key(function(d) {return d.Direction;})
		.key(function(d) {return d.Time;})
		.sortKeys(d3.ascending)
		.rollup(function(d)
		{
			return d3.mean(d, function(g) {return +g.CyclistCount;});
		})
		.map(csv_filtered);
		numdays = Math.ceil(csv_filtered.length/48);
		console.log(numdays);
	}
	
	function temp_brushed()
	{
		temp_selection = temp_brush.empty() ? temp_scale.domain() : temp_brush.extent();
		change();
	}
	function precip_brushed()
	{
		precip_selection = precip_brush.empty() ? precip_scale.domain() : precip_brush.extent();
		change();
	}
});
</script>