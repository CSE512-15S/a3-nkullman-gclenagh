<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3 Page Template</title>
        <script type="text/javascript" src="d3/d3.js"></script>
		<style>
			.axis path,
			.axis line {
				fill: none;
				stroke: black;
				shape-rendering: crispEdges;
			}

			.axis text {
				font-family: sans-serif;
				font-size: 11px;
			}
		</style>
    </head>
    <body>
	
		<p> Click on this bit of text to change the chart's y-axis from bike counts to precipitation (once) </p>
	
        <script type="text/javascript">
		
			/* Variables for SVG container */
			var w = 1000;
			var h = 300;
			var padding = 30;
			// needed more horizontal padding to accommodate y-axis
			var hpadding = padding + 10;
			
			/* Global var for the dataset we're working with */
			var dataset;
		
			/* Import CSV and make viz */
			d3.csv("FremontBikeAndWeatherData.csv",
				function(error, data) {
					if (error) {
						console.log(error);
					} else {
						console.log(data);
						dataset = data;
						generateVis();
					}
					// hideLoadingMsg();
				}
			);
			
			/* Generate visualization from dataset */
			function generateVis() {
			
				/* Create SVG holder */
				var svg = d3.select("body")
					.append("svg")
					.attr("width", w)
					.attr("height", h);
					
				/* Define date domain and format */
				var xDomain = d3.extent(dataset, function(d) { return new Date(d.Date); });
				var dateFormat = d3.time.format("%b %Y");
				
				/* Define cyclist count domain */
				// the + in '+d.CyclistCount' converts string to value
				var yDomain = d3.extent(dataset, function(d) { return +d.CyclistCount; });
					
				/* Define scales and axes */
				// time scale
				var xScale = d3.time.scale()
					.domain(xDomain)
					.range([hpadding, w - padding])
					.nice();
					
				var yScale = d3.scale.linear()
					.domain(yDomain)
					.range([h-padding, padding])
					.nice();
					
				var xAxis = d3.svg.axis()
					.orient("bottom")
					.scale(xScale)
					.tickFormat(dateFormat);
					
				var yAxis = d3.svg.axis()
					.orient("left")
					.scale(yScale);
				
				/* Create rectangles for the bar chart */
				var rects = svg.selectAll("rect")
					.data(dataset)
					.enter()
					.append("rect")
					.attr({
						//x: function(d) { return xScale(d.Date) - (w/dataset.length)/2; },
						x: function(d) { return xScale(new Date(d.Date)); },
						y: function(d) { return yScale(+d.CyclistCount); },
						width: w/dataset.length,
						height: function(d) { return h - padding - yScale(+d.CyclistCount); },
						fill: function(d) { return "rgb(0, 0, " + (+d.CyclistCount) + ")"; }
					});
				
				/* Create text labels for the bars 
					Super messy, so commenting out */
				/*
				var texts = svg.selectAll("text")
					.data(dataset)
					.enter()
					.append("text")
					.text( function(d) { return d.Date; })
					.attr({
						x: function (d,i) { return i * (w / dataset.length) + (w / dataset.length - barPadding) / 2; },
						y: function (d) { return h - +d.CyclistCount; }
					})
					.attr("font-family", "sans-serif")
					.attr("font-size", "11px")
					.attr("fill", "white")
					.attr("text-anchor", "middle");
				*/
				
				/* Draw axes */
				svg.append("g")
					.attr("class", "axis")
					.attr("transform", "translate(0, " + (h-padding) + ")")
					.call(xAxis);
				
				svg.append("g")
					.attr("class", "axis")
					.attr("transform", "translate("+(hpadding)+", 0)")
					.call(yAxis);
					
				/* Add event listener to update data once */
				d3.select("p")
					.on("click", function() {
						// do this on click:
						// redefine y-scale
						yScale.domain(d3.extent(dataset, function (d) { return +d.PrecipitationIn; }));
						// redraw rectangles
						svg.selectAll("rect")
							.data(dataset)
							.transition()
							.delay(function(d,i) { return i; })
							.duration(1000)
							.attr({
								x: function(d) { return xScale(new Date(d.Date)) ; },
								y: function (d) { return yScale(+d.PrecipitationIn); },
								height: function(d) { return h - padding - yScale(+d.PrecipitationIn); },
								fill: function(d) { return "rgb(0, 0, " + (+d.PrecipitationIn) + ")"; }
							});
							
						// redraw y-axis? Just draws on top... will need to figure this out better later
						svg.append("g")
							.attr("class", "axis")
							.attr("transform", "translate("+(hpadding)+", 0)")
							.call(yAxis);
					});
			};
        </script>
    </body>
</html>
